
import io
import math
import numpy as np
import pandas as pd
import streamlit as st

st.set_page_config(page_title="SKU æ–­è´§é£Žé™©è¯„ä¼°ï¼ˆA/B ç‰©æµï¼‰", layout="wide")

st.title("ðŸ“¦ SKU æ–­è´§é£Žé™©è¯„ä¼°ï¼ˆA/B ç‰©æµï¼‰")
st.caption("æ ¹æ®å‡ºè´§è¡¨ï¼ˆè‹±æ–‡åç§°+SKU+å°ºç é…æ¯”ï¼‰ã€åº“å­˜è¡¨ï¼ˆSKUç¼–ç +å½“å‰åº“å­˜ï¼‰ã€ä»¥åŠæ—¥å‡é”€é‡/å¢žé•¿ç³»æ•°ï¼Œè¯„ä¼°åœ¨ä¸åŒç‰©æµåˆ°è´§å¤©æ•°ä¸‹çš„æ–­è´§é£Žé™©ã€‚")

# -- Sidebar params --
st.sidebar.header("âš™ï¸ å‚æ•°è®¾ç½®")
lead_days_a = st.sidebar.number_input("A æ¸ é“åˆ°è´§å¤©æ•°", min_value=1, max_value=60, value=8, step=1)
lead_days_b = st.sidebar.number_input("B æ¸ é“åˆ°è´§å¤©æ•°", min_value=1, max_value=60, value=13, step=1)
lead_days = st.sidebar.radio("é€‰æ‹©è¦è¯„ä¼°çš„æ¸ é“", options=[("A æ¸ é“", lead_days_a), ("B æ¸ é“", lead_days_b)], index=1, format_func=lambda x: x[0])[1]

st.sidebar.markdown("---")
equal_share_default = st.sidebar.checkbox("å½“å‡ºè´§è¡¨æ— å°ºç æ‹†åˆ†æ—¶ä½¿ç”¨ S/M/L å¹³å‡æ‹†åˆ†ï¼ˆ1/3ï¼‰", value=True)

st.sidebar.markdown("---")
st.sidebar.subheader("ðŸ“ ä¸Šä¼ æ•°æ®æ–‡ä»¶")
shipment_file = st.sidebar.file_uploader("å‡ºè´§è¡¨ï¼ˆCSVï¼‰å¿…é¡»åŒ…å«åˆ—ï¼šè‹±æ–‡åç§°ã€SKUã€Sæ•°é‡ã€Mæ•°é‡ã€Læ•°é‡", type=["csv"])
inventory_file = st.sidebar.file_uploader("åº“å­˜è¡¨ï¼ˆCSVï¼‰å¿…é¡»åŒ…å«åˆ—ï¼šSKUç¼–ç ã€å½“å‰åº“å­˜ï¼ˆç¤ºä¾‹ï¼šNPF001-Sï¼‰", type=["csv"])
restock_file = st.sidebar.file_uploader("é”€é‡å¢žé•¿è¡¨ï¼ˆXLSX/CSVï¼‰å¿…é¡»åŒ…å«åˆ—ï¼šVariation Nameã€æ—¥å‡é”€é‡ã€å¢žé•¿ç³»æ•°", type=["xlsx","csv"])

st.markdown("### ä½¿ç”¨è¯´æ˜Ž")
with st.expander("ç‚¹å‡»å±•å¼€"):
    st.markdown("""
    1. åœ¨å·¦ä¾§ä¸Šä¼ ä¸‰å¼ è¡¨ï¼š  
       - **å‡ºè´§è¡¨ï¼ˆCSVï¼‰**ï¼šè‡³å°‘åŒ…å« `è‹±æ–‡åç§°, SKU, Sæ•°é‡, Mæ•°é‡, Læ•°é‡`  
       - **åº“å­˜è¡¨ï¼ˆCSVï¼‰**ï¼šè‡³å°‘åŒ…å« `SKUç¼–ç , å½“å‰åº“å­˜`ï¼ŒSKUç¼–ç å½¢å¦‚ `NPF001-S`  
       - **é”€é‡å¢žé•¿è¡¨ï¼ˆXLSX/CSVï¼‰**ï¼šè‡³å°‘åŒ…å« `Variation Name, æ—¥å‡é”€é‡, å¢žé•¿ç³»æ•°`  
    2. åœ¨å·¦ä¾§é€‰æ‹©æ¸ é“ï¼ˆA=8å¤©ï¼ŒB=13å¤©ï¼Œæˆ–è‡ªå®šä¹‰ï¼‰ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è®¡ç®—ã€‚
    3. æ”¯æŒä¸‹è½½ç»“æžœ CSVã€‚
    """)

def _safe_read(file):
    if file is None:
        return None
    name = file.name.lower()
    if name.endswith(".xlsx"):
        return pd.read_excel(file)
    else:
        return pd.read_csv(file)

def compute_stockout_risk(a_chain: pd.DataFrame, inventory: pd.DataFrame, restock: pd.DataFrame, lead_days: int = 13, use_equal_share_if_missing=True) -> pd.DataFrame:
    # æ¸…æ´—å¹¶ä¿ç•™éœ€è¦çš„åˆ—
    cols_ship = ["è‹±æ–‡åç§°","SKU","Sæ•°é‡","Mæ•°é‡","Læ•°é‡"]
    missing_ship = [c for c in cols_ship if c not in a_chain.columns]
    if missing_ship:
        raise ValueError(f"å‡ºè´§è¡¨ç¼ºå°‘åˆ—: {missing_ship}")
    ship = a_chain[cols_ship].dropna(subset=["SKU"]).copy()
    for c in ["Sæ•°é‡","Mæ•°é‡","Læ•°é‡"]:
        ship[c] = pd.to_numeric(ship[c], errors="coerce").fillna(0.0)

    # å°ºç å æ¯”
    ship["æ€»æ•°é‡"] = ship[["Sæ•°é‡","Mæ•°é‡","Læ•°é‡"]].sum(axis=1)
    def compute_shares(row):
        total = row["æ€»æ•°é‡"]
        if total and total > 0:
            return pd.Series({
                "share_S": row["Sæ•°é‡"]/total,
                "share_M": row["Mæ•°é‡"]/total,
                "share_L": row["Læ•°é‡"]/total
            })
        else:
            if use_equal_share_if_missing:
                return pd.Series({"share_S": 1/3, "share_M": 1/3, "share_L": 1/3})
            else:
                return pd.Series({"share_S": np.nan, "share_M": np.nan, "share_L": np.nan})
    ship = pd.concat([ship, ship.apply(compute_shares, axis=1)], axis=1)

    # åç§°æ˜ å°„
    if "Variation Name" not in restock.columns or "æ—¥å‡é”€é‡" not in restock.columns or "å¢žé•¿ç³»æ•°" not in restock.columns:
        raise ValueError("é”€é‡å¢žé•¿è¡¨éœ€åŒ…å«åˆ—ï¼šVariation Name, æ—¥å‡é”€é‡, å¢žé•¿ç³»æ•°")
    name_to_sku = ship.set_index("è‹±æ–‡åç§°")["SKU"].to_dict()
    r = restock.copy()
    r["base_SKU"] = r["Variation Name"].map(name_to_sku)

    # ä»…è¯„ä¼°å‡ºè´§è¡¨ä¸­å­˜åœ¨æ˜ å°„çš„æ¬¾å¼
    r_ship = r.dropna(subset=["base_SKU"]).copy()

    # åˆå¹¶å°ºç å æ¯”
    r_ship = r_ship.merge(
        ship[["è‹±æ–‡åç§°","SKU","share_S","share_M","share_L"]].rename(columns={"SKU":"base_SKU"}),
        on=["base_SKU"],
        how="left"
    )

    # åº“å­˜æ‹†åˆ†
    if "SKUç¼–ç " not in inventory.columns or "å½“å‰åº“å­˜" not in inventory.columns:
        raise ValueError("åº“å­˜è¡¨éœ€åŒ…å«åˆ—ï¼šSKUç¼–ç , å½“å‰åº“å­˜")
    inv = inventory.copy()
    inv["base_SKU"] = inv["SKUç¼–ç "].astype(str).str.split("-").str[0]
    inv["size"] = inv["SKUç¼–ç "].astype(str).str.split("-").str[1]
    inv_pivot = inv.pivot_table(index=["base_SKU"], columns="size", values="å½“å‰åº“å­˜", aggfunc="sum").fillna(0)
    for s in ["S","M","L"]:
        if s not in inv_pivot.columns:
            inv_pivot[s] = 0
    inv_pivot = inv_pivot.reset_index()

    # èšåˆåˆ° base_SKUï¼ˆè‹¥å¢žé•¿è¡¨æœ‰é‡å¤æ¬¾å¼ï¼Œåªå–ç¬¬ä¸€æ¡å³å¯ï¼›ä¹Ÿå¯æ”¹ä¸ºåˆ«çš„ç­–ç•¥ï¼‰
    r_base = r_ship.groupby("base_SKU", as_index=False).first()
    df = r_base.merge(inv_pivot, on="base_SKU", how="left")

    # ç¼ºçœå æ¯”å¡«å……
    for col in ["share_S","share_M","share_L"]:
        if col not in df.columns:
            df[col] = np.nan
    df[["share_S","share_M","share_L"]] = df[["share_S","share_M","share_L"]].fillna(1/3 if use_equal_share_if_missing else 0)

    # éœ€æ±‚é¢„æµ‹ï¼ˆå¢žé•¿ç³»æ•°å‡è®¾ä¸ºâ€œå‘¨â€å£å¾„ï¼Œè½¬ä¸ºâ€œæ—¥â€å£å¾„ï¼‰
    def project_demand(daily_avg, growth_coef, share, days):
        if pd.isna(daily_avg) or daily_avg is None:
            return 0.0
        try:
            daily_avg = float(daily_avg)
        except:
            daily_avg = 0.0
        try:
            g = float(growth_coef)
            g_daily = (g ** (1/7.0)) if g > 0 else 1.0
        except:
            g_daily = 1.0
        base = daily_avg * float(share or 0)
        if abs(g_daily - 1.0) < 1e-9:
            return base * days
        else:
            return float(base * (1 - (g_daily ** days)) / (1 - g_daily))

    for s in ["S","M","L"]:
        df[f"proj{s}_{lead_days}d"] = df.apply(lambda r: project_demand(r.get("æ—¥å‡é”€é‡"), r.get("å¢žé•¿ç³»æ•°"), r.get(f"share_{s}"), lead_days), axis=1)

    # é€æ—¥æ‰£å‡çœ‹æœ€æ—©æ–­è´§æ—¥
    def stockout_day(initial, daily_avg, growth_coef, share, days):
        stock = float(initial) if pd.notna(initial) else 0.0
        try:
            daily_avg = float(daily_avg)
        except:
            daily_avg = 0.0
        try:
            g = float(growth_coef)
            g_daily = (g ** (1/7.0)) if g > 0 else 1.0
        except:
            g_daily = 1.0
        demand_today = daily_avg * float(share or 0)
        for d in range(1, days+1):
            stock -= demand_today
            if stock < 0:
                return d
            demand_today *= g_daily
        return np.nan

    for s in ["S","M","L"]:
        df[f"stockout_day_{s}"] = df.apply(lambda r: stockout_day(r.get(s,0), r.get("æ—¥å‡é”€é‡"), r.get("å¢žé•¿ç³»æ•°"), r.get(f"share_{s}"), lead_days), axis=1)
        df[f"risk_{s}"] = df[f"stockout_day_{s}"].notna()

    df["risk_any_size"] = df[[f"risk_{s}" for s in ["S","M","L"]]].any(axis=1)

    out_cols = [
        "Variation Name","base_SKU","æ—¥å‡é”€é‡","å¢žé•¿ç³»æ•°",
        "S","M","L","share_S","share_M","share_L",
        f"projS_{lead_days}d", f"projM_{lead_days}d", f"projL_{lead_days}d",
        "stockout_day_S","stockout_day_M","stockout_day_L",
        "risk_S","risk_M","risk_L","risk_any_size"
    ]
    result = df[out_cols].copy()
    result = result.rename(columns={
        "S":"å½“å‰åº“å­˜_S","M":"å½“å‰åº“å­˜_M","L":"å½“å‰åº“å­˜_L",
        "risk_any_size": f"{lead_days}å¤©å†…æ˜¯å¦å­˜åœ¨æ–­è´§é£Žé™©"
    })
    # è®¡ç®—æœ€æ—©æ–­è´§å¤©æ•°ï¼ˆä»»ä¸€å°ºç ï¼‰
    def earliest(row):
        days = [row["stockout_day_S"], row["stockout_day_M"], row["stockout_day_L"]]
        days = [d for d in days if pd.notna(d)]
        return min(days) if days else np.nan
    result["æœ€æ—©æ–­è´§å¤©æ•°(ä»»ä¸€å°ºç )"] = result.apply(earliest, axis=1)
    # æŽ’åºï¼šå…ˆæœ‰é£Žé™©çš„ï¼Œå†æŒ‰æœ€æ—©æ–­è´§å¤©æ•°å‡åº
    result = result.sort_values(by=[f"{lead_days}å¤©å†…æ˜¯å¦å­˜åœ¨æ–­è´§é£Žé™©","æœ€æ—©æ–­è´§å¤©æ•°(ä»»ä¸€å°ºç )"], ascending=[False, True])
    return result

# -- Run --
if st.button(f"ðŸš€ è®¡ç®— {lead_days} å¤©æ–­è´§é£Žé™©", use_container_width=True):
    try:
        a_chain = _safe_read(shipment_file)
        inventory = _safe_read(inventory_file)
        restock = _safe_read(restock_file)
        if any(x is None for x in [a_chain, inventory, restock]):
            st.error("è¯·å…ˆä¸Šä¼ ä¸‰å¼ è¡¨å†è®¡ç®—ã€‚")
        else:
            res = compute_stockout_risk(a_chain, inventory, restock, lead_days=lead_days, use_equal_share_if_missing=equal_share_default)

            # KPI åŒº
            total = int(res.shape[0])
            risky = int(res[f"{lead_days}å¤©å†…æ˜¯å¦å­˜åœ¨æ–­è´§é£Žé™©"].sum())
            col1, col2, col3 = st.columns(3)
            col1.metric("è¦†ç›– base SKU æ•°", total)
            col2.metric("å­˜åœ¨æ–­è´§é£Žé™©ï¼ˆä»»ä¸€å°ºç ï¼‰", risky)
            ratio = f"{(risky/total*100):.1f}%" if total else "0.0%"
            col3.metric("é£Žé™©å æ¯”", ratio)

            st.markdown("### ç»“æžœæ˜Žç»†")
            st.dataframe(res, use_container_width=True, height=520)

            # ä¸‹è½½
            csv = res.to_csv(index=False).encode("utf-8-sig")
            st.download_button(
                label="â¬‡ï¸ ä¸‹è½½ç»“æžœ CSV",
                data=csv,
                file_name=f"stockout_risk_{lead_days}days.csv",
                mime="text/csv",
                use_container_width=True
            )

            st.success("è®¡ç®—å®Œæˆ âœ…")
    except Exception as e:
        st.exception(e)

st.markdown("---")
st.markdown("**æç¤ºï¼š** å¦‚éœ€åœ¨æœ¬åœ°ç›´æŽ¥ä½¿ç”¨è„šæœ¬æ‰¹å¤„ç†ï¼Œå¯å‚è€ƒæˆ‘ä»¬éšé™„çš„ `stockout_risk_b_channel.py`ï¼Œæˆ–å°†æœ¬é¡µé¢çš„é€»è¾‘æ”¹ä¸ºå‘½ä»¤è¡Œè°ƒç”¨ã€‚")
